// =============================================================================
// SCHEMA PRISMA - IAMOVE STUDIO
// =============================================================================
// Studio de création de sites web pour l'accompagnement des compétences IA
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// UTILISATEURS DU STUDIO
// =============================================================================

model StudioUser {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String    // Hash bcrypt
  role          UserRole  @default(STANDARD)
  language      String    @default("FR")  // Langue préférée (code ISO)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  sites         Site[]
  sharedSites   Site[]        @relation("SharedSiteUsers") // Sites partagés avec cet utilisateur
  folders       SiteFolder[]
  quizzes       Quiz[]        // Quizz créés par les admins

  @@map("studio_users")
}

enum UserRole {
  STANDARD
  ADMIN
}

enum PersonRole {
  STANDARD
  ADMIN
}

// =============================================================================
// DOSSIERS DE SITES
// =============================================================================

model SiteFolder {
  id            String    @id @default(cuid())
  name          String
  parentId      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  owner         StudioUser @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId       String
  parent        SiteFolder? @relation("FolderHierarchy", fields: [parentId], references: [id])
  children      SiteFolder[] @relation("FolderHierarchy")
  sites         Site[]

  @@map("site_folders")
}

// =============================================================================
// SITES (ENTREPRISES)
// =============================================================================

model Site {
  id            String      @id @default(cuid())
  name          String
  slug          String      @unique   // URL du site publié
  description   String?
  logo          String?     // URL du logo
  primaryColor  String      @default("#3B82F6")
  secondaryColor String     @default("#8B5CF6")
  language      String      @default("FR")  // Langue du contenu LOCAL du site
  isPublished   Boolean     @default(false)
  publishedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  owner         StudioUser  @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId       String
  folder        SiteFolder? @relation(fields: [folderId], references: [id])
  folderId      String?
  persons       Person[]
  settings      SiteSettings?
  registrationTokens RegistrationToken[]
  useCases      UseCase[]
  forumPosts    ForumPost[]
  techTips      TechTip[]
  badges        Badge[]
  backlogItems  BacklogItem[]

  // Utilisateurs Studio ayant accès à ce site (partage)
  sharedWith    StudioUser[]  @relation("SharedSiteUsers")

  // Contenus partagés depuis d'autres sites (accès cross-site, même ID)
  sharedUseCases  UseCase[]   @relation("SharedUseCases")
  sharedForumPosts ForumPost[] @relation("SharedForumPosts")
  sharedTechTips  TechTip[]   @relation("SharedTechTips")

  @@map("sites")
}

// Token d'inscription à usage unique
model RegistrationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  usedAt    DateTime? // null = non utilisé, date = utilisé
  createdAt DateTime @default(now())
  expiresAt DateTime // Expiration après 7 jours

  @@map("registration_tokens")
}

// =============================================================================
// PARAMÈTRES DU SITE
// =============================================================================

model SiteSettings {
  id                    String   @id @default(cuid())
  
  // Onglet 1 - Liste des personnes
  tab1Title             String   @default("Équipe")
  tab1Enabled           Boolean  @default(true)
  tab1ColumnsVisible    String[] @default(["name", "email", "level", "position"])
  
  // Onglet 2 - Organigramme
  tab2Title             String   @default("Organisation")
  tab2Enabled           Boolean  @default(true)
  tab2Layout            String   @default("vertical") // vertical, horizontal
  
  // Onglet 3 - Fiche personne
  tab3Title             String   @default("Profil")
  tab3Enabled           Boolean  @default(true)
  
  // Onglet 4 - Formation IA
  tab4Title             String   @default("Formation")
  tab4Enabled           Boolean  @default(true)
  tab4SystemPrompt      String   @default("Tu es un assistant spécialisé dans la formation aux compétences IA en entreprise.")
  tab4HiddenModuleIds   String[] @default([])  // IDs de modules masqués (vide = tout visible)
  
  // Onglet 5 - Quizz
  tab5Title             String   @default("Évaluation")
  tab5Enabled           Boolean  @default(true)
  tab5QuestionsPerQuiz  Int      @default(20)
  tab5PassThreshold     Int      @default(10)
  
  // Inscription publique
  allowPublicRegistration Boolean @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  site                  Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId                String   @unique

  @@map("site_settings")
}

// =============================================================================
// PERSONNES (EMPLOYÉS D'UNE ENTREPRISE)
// =============================================================================

model Person {
  id                String    @id @default(cuid())
  email             String
  name              String
  firstName         String?
  lastName          String?
  jobTitle          String?   // Poste/fonction
  department        String?   // Service/département
  phone             String?
  avatar            String?   // URL avatar
  
  // Authentification
  password          String?   // Hash bcrypt (null = pas encore initialisé)
  inviteToken       String?   @unique // Token pour initialiser le mot de passe
  inviteExpiresAt   DateTime?
  inviteClickedAt   DateTime? // Date du premier clic sur le lien d'invitation (sans finalisation)
  lastLoginAt       DateTime?
  isOnline          Boolean   @default(false)
  lastSeenAt        DateTime?
  
  // Niveau IA
  currentLevel      Int       @default(0)
  
  // Serious game : points de participation (usage site publié uniquement)
  participationPoints Int     @default(0)
  
  // Préférences
  language          String    @default("EN") // Langue préférée (EN par défaut en mode publié)
  
  // Rôle dans le site publié (admin = gestion utilisateurs + vue complète)
  personRole        PersonRole @default(STANDARD)
  
  // Droits spéciaux
  canViewAll        Boolean   @default(false) // Vue élargie
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  site              Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId            String
  
  // Hiérarchie (organigramme)
  managerId         String?
  manager           Person?   @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates      Person[]  @relation("ManagerSubordinates")
  
  // Compétences validées
  skills            PersonSkill[]
  
  // Tentatives de quizz
  quizAttempts      QuizAttempt[]
  
  // Historique chat IA
  chatMessages      ChatMessage[]
  
  // Progression de formation
  trainingProgress  PersonTrainingProgress[]

  // Use cases IA
  useCases          UseCase[]
  useCaseLikes      UseCaseLike[]

  // Backlog
  backlogItems         BacklogItem[]  @relation("BacklogCreator")
  ownedBacklogItems    BacklogItem[]  @relation("BacklogOwner")
  sponsoredBacklogItems BacklogItem[] @relation("BacklogSponsor")

  // Forum
  forumPosts        ForumPost[]
  forumReplies      ForumReply[]

  // Tech tips
  techTips          TechTip[]
  techTipLikes      TechTipLike[]

  // Badges
  badges            PersonBadge[]

  @@unique([siteId, email])
  @@map("persons")
}

// =============================================================================
// NIVEAUX IA
// =============================================================================

model Level {
  id            String    @id @default(cuid())
  number        Int       @unique // 0-20 (21 niveaux)
  name          String    // "Ignorant", "Touriste", etc. (FR par défaut)
  category      String    @default("") // "Néophyte", "Utilisateur", "Technicien", "Chercheur"
  seriousGaming String    @default("") // Nom Star Wars
  description   String    @default("")
  color         String    @default("#3B82F6")
  requiredScore Int       @default(10) // Score requis pour valider
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  quizzes         Quiz[]
  skills          Skill[]
  trainingModules TrainingModule[]
  trainingPaths   TrainingPath[]
  translations    LevelTranslation[]

  @@map("levels")
}

model LevelTranslation {
  id            String   @id @default(cuid())
  levelId       String
  language      String   // EN, DE, ES, IT, etc. (26 langues)
  name          String   // Nom traduit
  category      String   // Catégorie traduite
  seriousGaming String   // Nom serious gaming traduit
  description   String   // Description traduite
  
  level         Level    @relation(fields: [levelId], references: [id], onDelete: Cascade)
  
  @@unique([levelId, language])
  @@map("level_translations")
}

// =============================================================================
// COMPÉTENCES
// =============================================================================

model Skill {
  id            String    @id @default(cuid())
  name          String
  description   String?
  category      String?   // Catégorie de compétence
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  level         Level     @relation(fields: [levelId], references: [id])
  levelId       String
  personSkills  PersonSkill[]

  @@map("skills")
}

// =============================================================================
// COMPÉTENCES VALIDÉES PAR PERSONNE
// =============================================================================

model PersonSkill {
  id            String    @id @default(cuid())
  validatedAt   DateTime  @default(now())
  selfDeclared  Boolean   @default(true) // Auto-déclaré par la personne
  notes         String?

  // Relations
  person        Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId      String
  skill         Skill     @relation(fields: [skillId], references: [id], onDelete: Cascade)
  skillId       String

  @@unique([personId, skillId])
  @@map("person_skills")
}

// =============================================================================
// QUESTIONS QUIZZ
// =============================================================================

model Quiz {
  id            String    @id @default(cuid())
  question      String    @db.Text // Question en français (langue par défaut)
  
  // Réponses (JSON array: [{text: string, isCorrect: boolean}])
  answers       Json      // Max 4 réponses
  
  explanation   String?   @db.Text // Explication de la bonne réponse
  category      String?   // Catégorie de la question
  difficulty    Int       @default(1) // 1-3
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  level         Level     @relation(fields: [levelId], references: [id])
  levelId       String
  createdBy     StudioUser @relation(fields: [createdById], references: [id])
  createdById   String
  attempts      QuizAttempt[]
  translations  QuizTranslation[]

  @@map("quizzes")
}

// =============================================================================
// TRADUCTIONS QUIZZ (26 langues)
// =============================================================================

model QuizTranslation {
  id            String    @id @default(cuid())
  
  // Langue (code ISO: FR, EN, DE, ES, etc.)
  language      String
  
  // Question traduite
  question      String    @db.Text
  
  // Réponses traduites (JSON array: [{text: string, isCorrect: boolean}])
  answers       Json
  
  // Explication traduite
  explanation   String?   @db.Text
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  quiz          Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId        String

  @@unique([quizId, language])
  @@index([language])
  @@map("quiz_translations")
}

// =============================================================================
// TENTATIVES DE QUIZZ
// =============================================================================

model QuizAttempt {
  id            String    @id @default(cuid())
  
  // Réponses données par l'utilisateur (indices des réponses cochées)
  selectedAnswers Int[]
  isCorrect     Boolean
  
  attemptedAt   DateTime  @default(now())

  // Relations
  person        Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId      String
  quiz          Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId        String

  @@map("quiz_attempts")
}

// =============================================================================
// MESSAGES CHAT IA (FORMATION)
// =============================================================================

model ChatMessage {
  id            String    @id @default(cuid())
  role          ChatRole  // user, assistant, system
  content       String    @db.Text
  
  // Métadonnées
  tokens        Int?      // Nombre de tokens utilisés
  model         String?   // Modèle utilisé
  
  createdAt     DateTime  @default(now())

  // Relations
  person        Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId      String

  @@map("chat_messages")
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

// =============================================================================
// SESSIONS (pour le suivi des connexions)
// =============================================================================

model Session {
  id            String    @id @default(cuid())
  sessionToken  String    @unique
  
  // Type de session
  userType      SessionUserType
  userId        String    // ID du StudioUser ou Person
  
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  
  // Données de session
  ipAddress     String?
  userAgent     String?

  @@map("sessions")
}

enum SessionUserType {
  STUDIO_USER
  PERSON
}

// =============================================================================
// MÉTHODES DE FORMATION
// =============================================================================

model TrainingMethod {
  id            String    @id @default(cuid())
  name          String    // Nom de la méthode (ex: "Serious Game")
  description   String?   @db.Text
  icon          String?   // Icône (nom Lucide ou URL)
  type          TrainingMethodType @default(TUTORIAL)
  isActive      Boolean   @default(true)
  order         Int       @default(0) // Ordre d'affichage
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  modules       TrainingModule[]
  translations  TrainingMethodTranslation[]

  @@map("training_methods")
}

enum TrainingMethodType {
  SERIOUS_GAME    // Jeux sérieux interactifs
  TUTORIAL        // Tutoriels pas à pas
  EXERCISE        // Exercices pratiques
  VIDEO           // Vidéos de formation
  ARTICLE         // Articles/lectures
  INTERACTIVE     // Modules interactifs
}

model TrainingMethodTranslation {
  id            String    @id @default(cuid())
  language      String    // Code ISO (FR, EN, etc.)
  name          String    // Nom traduit
  description   String?   @db.Text // Description traduite
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  method        TrainingMethod @relation(fields: [methodId], references: [id], onDelete: Cascade)
  methodId      String

  @@unique([methodId, language])
  @@map("training_method_translations")
}

// =============================================================================
// MODULES DE FORMATION
// =============================================================================

model TrainingModule {
  id                String    @id @default(cuid())
  title             String
  description       String?   @db.Text
  content           String?   @db.Text // Contenu HTML/Markdown
  duration          Int       @default(15) // Durée estimée en minutes
  difficulty        Int       @default(1) // 1-5
  order             Int       @default(0)
  isActive          Boolean   @default(true)
  
  // Exercices pratiques (JSON)
  // Format: [{ title, description, instructions, expectedResult, aiPrompt }]
  practicalExercises Json?
  
  // Ressources (JSON)
  // Format: [{ type, title, url, description }]
  resources         Json?

  // PDF généré à partir de la page source de l'article
  pdfData           Bytes?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  method            TrainingMethod @relation(fields: [methodId], references: [id], onDelete: Cascade)
  methodId          String
  level             Level     @relation(fields: [levelId], references: [id])
  levelId           String
  translations      TrainingModuleTranslation[]
  progress          PersonTrainingProgress[]
  pathItems         TrainingPathItem[]

  @@map("training_modules")
}

model TrainingModuleTranslation {
  id            String    @id @default(cuid())
  language      String
  title         String
  description   String?   @db.Text
  content       String?   @db.Text
  practicalExercises Json? // Exercices traduits
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  module        TrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId      String

  @@unique([moduleId, language])
  @@map("training_module_translations")
}

// =============================================================================
// PARCOURS DE FORMATION (enchaînements d’éléments vers un objectif)
// =============================================================================

model TrainingPath {
  id          String    @id @default(cuid())
  name        String    // Ex: "Parcours IA débutant"
  description String?   @db.Text
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  levelId     String?   // Niveau recommandé pour ce parcours (optionnel)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  level       Level?    @relation(fields: [levelId], references: [id])
  items       TrainingPathItem[]

  @@map("training_paths")
}

model TrainingPathItem {
  id       String   @id @default(cuid())
  order    Int      @default(0) // Position dans le parcours
  pathId   String
  moduleId String

  path   TrainingPath   @relation(fields: [pathId], references: [id], onDelete: Cascade)
  module TrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([pathId, moduleId])
  @@map("training_path_items")
}

// =============================================================================
// PROGRESSION DE FORMATION
// =============================================================================

model PersonTrainingProgress {
  id              String    @id @default(cuid())
  status          TrainingStatus @default(NOT_STARTED)
  score           Int?      // Score obtenu (0-100)
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Résultats des exercices pratiques (JSON)
  // Format: [{ exerciseId, completed, notes, result }]
  practicalResults Json?
  
  // Temps passé (en minutes)
  timeSpent       Int       @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  person          Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId        String
  module          TrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId        String

  @@unique([personId, moduleId])
  @@map("person_training_progress")
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

// =============================================================================
// TRADUCTIONS (i18n)
// =============================================================================

model Translation {
  id            String    @id @default(cuid())
  
  // Clé de traduction (ex: "nav.studio", "header.mySites")
  key           String
  
  // Langue (code ISO: FR, EN, DE, ES, etc.)
  language      String
  
  // Texte traduit
  value         String    @db.Text
  
  // Type: GLOBAL (studio) ou LOCAL (contenu de site)
  type          TranslationType @default(GLOBAL)
  
  // Pour les traductions LOCAL, lien vers le site
  siteId        String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([key, language, type])
  @@index([language, type])
  @@index([siteId, language])
  @@map("translations")
}

enum TranslationType {
  GLOBAL
  LOCAL
}

// =============================================================================
// USE CASES IA (partage d'expériences entre personnes)
// =============================================================================

model UseCase {
  id          String        @id @default(cuid())
  title       String
  description String        @db.Text
  category    String?       // "Automatisation", "Analyse", "Génération", "Productivité", etc.
  tools       String?       // Outils utilisés (ChatGPT, Copilot, etc.)
  impact      String?       // Impact observé
  url         String?       // URL partagée par le créateur
  status      UseCaseStatus @default(PUBLISHED)

  person      Person        @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId    String
  site        Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId      String

  likes       UseCaseLike[]
  sharedWith  Site[]        @relation("SharedUseCases")

  // Lien optionnel vers le backlog d'origine
  backlogItem   BacklogItem? @relation(fields: [backlogItemId], references: [id])
  backlogItemId String?      @unique

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("use_cases")
}

enum UseCaseStatus {
  DRAFT
  PUBLISHED
}

model UseCaseLike {
  id        String   @id @default(cuid())
  useCase   UseCase  @relation(fields: [useCaseId], references: [id], onDelete: Cascade)
  useCaseId String
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId  String
  createdAt DateTime @default(now())

  @@unique([useCaseId, personId])
  @@map("use_case_likes")
}

// =============================================================================
// BACKLOG (gestion structurée des cas d'usage)
// =============================================================================

enum BacklogStatus {
  A_VALIDER       // Proposé, en attente de validation
  EN_ATTENTE      // En attente d'informations ou de décision
  VALIDE          // Validé pour exécution
  REFUSE          // Refusé
  EN_DEV          // En cours de développement
  MEP             // Mis en production
}

model BacklogItem {
  id               String        @id @default(cuid())
  title            String
  description      String        @db.Text
  service          String?       // Service / département concerné
  category         String?       // Catégorie métier
  tools            String?       // Outils / technologies envisagés
  impact           String?       // Impact attendu
  url              String?       // URL de référence
  priority         Int           @default(0) // 0 = non priorisé, 1 = haute, 2 = moyenne, 3 = basse
  status           BacklogStatus @default(A_VALIDER)
  estimatedEffort  String?       // Charge prévisionnelle (ex: "5 jours", "2 sprints")
  actualEffort     String?       // Charge réelle
  targetDate       DateTime?     // Date cible
  notes            String?       @db.Text // Notes du scrum master / refinement

  // Créateur (la personne qui propose)
  creator          Person        @relation("BacklogCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId        String

  // Owner (responsable de la réalisation)
  owner            Person?       @relation("BacklogOwner", fields: [ownerId], references: [id])
  ownerId          String?

  // Sponsor (commanditaire)
  sponsor          Person?       @relation("BacklogSponsor", fields: [sponsorId], references: [id])
  sponsorId        String?

  // Site
  site             Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId           String

  // Lien vers le UseCase créé lors de la promotion MEP
  promotedUseCase  UseCase?

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@map("backlog_items")
}

// =============================================================================
// FORUM (discussions par site)
// =============================================================================

model ForumPost {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  category  String?  // "Question", "Discussion", "Partage", "Aide"

  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId  String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId    String

  replies   ForumReply[]
  sharedWith Site[]  @relation("SharedForumPosts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("forum_posts")
}

model ForumReply {
  id        String   @id @default(cuid())
  content   String   @db.Text

  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId  String
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("forum_replies")
}

// =============================================================================
// TECH TIPS (conseils techniques partagés)
// =============================================================================

model TechTip {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  category  String?  // "API", "Outil", "Méthode", "Service Web", "Prompt"

  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId  String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId    String

  likes     TechTipLike[]
  sharedWith Site[]  @relation("SharedTechTips")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tech_tips")
}

model TechTipLike {
  id        String   @id @default(cuid())
  techTip   TechTip  @relation(fields: [techTipId], references: [id], onDelete: Cascade)
  techTipId String
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId  String
  createdAt DateTime @default(now())

  @@unique([techTipId, personId])
  @@map("tech_tip_likes")
}

// =============================================================================
// BADGES (Serious Game)
// =============================================================================

model Badge {
  id          String   @id @default(cuid())
  name        String
  description String?
  icon        String?  // Emoji ou nom d'icône
  category    String?  // "Formation", "Quiz", "UseCase", "Forum", "Tech", "PP"
  criteria    String?  @db.Text // JSON : conditions d'obtention
  ppReward    Int      @default(0) // PP gagnés en obtenant ce badge

  site        Site?    @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId      String?  // null = badge global

  earnedBy    PersonBadge[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("badges")
}

model PersonBadge {
  id        String   @id @default(cuid())
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId  String
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  badgeId   String
  earnedAt  DateTime @default(now())

  @@unique([personId, badgeId])
  @@map("person_badges")
}
